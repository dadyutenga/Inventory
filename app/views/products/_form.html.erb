<%= form_with(model: product, local: true, class: "product-form", html: { multipart: true }) do |form| %>
  <% if product.errors.any? %>
    <div class="error-messages">
      <h2><%= pluralize(product.errors.count, "error") %> prohibited this product from being saved:</h2>
      <ul>
        <% product.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-section">
    <h2>General Information</h2>

    <div class="form-row">
      <div class="form-group">
        <%= form.label :name, "Name *" %>
        <%= form.text_field :name, required: true, class: "form-control" %>
      </div>
      <div class="form-group">
        <%= form.label :category, "Category *" %>
        <%= form.select :category, Product.categories.keys.map { |c| [c.humanize, c] }, {}, class: "form-control" %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <%= form.label :sku, "SKU *" %>
        <%= form.text_field :sku, required: true, class: "form-control" %>
      </div>
      <div class="form-group">
        <%= form.label :serial_number, "Serial Number *" %>
        <%= form.text_field :serial_number, required: true, class: "form-control" %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <%= form.label :brand %>
        <%= form.text_field :brand, class: "form-control" %>
      </div>
      <div class="form-group">
        <%= form.label :model %>
        <%= form.text_field :model, class: "form-control" %>
      </div>
      <div class="form-group">
        <%= form.label :model_number %>
        <%= form.text_field :model_number, class: "form-control" %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <%= form.label :vendor %>
        <%= form.text_field :vendor, class: "form-control" %>
      </div>
      <div class="form-group">
        <%= form.label :location %>
        <%= form.text_field :location, class: "form-control" %>
      </div>
      <div class="form-group">
        <%= form.label :allocated_to_id, "Allocated To" %>
        <%= form.collection_select :allocated_to_id, User.all, :id, :name, include_blank: true, class: "form-control" %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <%= form.label :status %>
        <%= form.select :status, Product.statuses.keys.map { |s| [s.humanize, s] }, {}, class: "form-control" %>
      </div>
      <div class="form-group">
        <%= form.label :condition %>
        <%= form.select :condition, Product.conditions.keys.map { |c| [c.humanize, c] }, {}, class: "form-control" %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <%= form.label :purchase_date %>
        <%= form.date_field :purchase_date, class: "form-control" %>
      </div>
      <div class="form-group">
        <%= form.label :purchase_price %>
        <%= form.number_field :purchase_price, step: 0.01, min: 0, class: "form-control" %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <%= form.label :last_service_date %>
        <%= form.date_field :last_service_date, class: "form-control" %>
      </div>
      <div class="form-group">
        <%= form.label :next_service_due %>
        <%= form.date_field :next_service_due, class: "form-control" %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group full-width">
        <%= form.label :notes %>
        <%= form.text_area :notes, rows: 3, class: "form-control" %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group full-width">
        <%= form.label :images, "Images" %>
        
        <% if product.persisted? && product.images.attached? %>
          <div class="existing-images">
            <p class="existing-images-label">Current Images:</p>
            <div class="image-grid">
              <% product.images.each do |image| %>
                <div class="image-item">
                  <%= image_tag image, style: "width: 120px; height: 80px; object-fit: cover; border-radius: 4px;" %>
                  <%= button_to "Remove", remove_image_product_path(product, image_id: image.id), method: :delete, 
                                class: "remove-image-btn", 
                                data: { turbo_confirm: "Remove this image?" }, 
                                form: { style: "display: inline;" } %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
        
        <%= form.file_field :images, multiple: true, accept: "image/*", class: "form-control image-upload" %>
        <p class="upload-help">Select multiple images (JPG, PNG, GIF). Hold Ctrl/Cmd to select multiple files.</p>
      </div>
    </div>
  </div>

  <div class="form-section">
    <h2>Equipment Details</h2>
    <%= render partial: "products/equipment_fields", locals: { form: form, product: product } %>
  </div>

  <div class="form-actions">
    <%= form.submit class: "btn" %>
    <%= link_to "Cancel", products_path, class: "btn" %>
  </div>
<% end %>

<style>
.product-form { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 24px; box-shadow: 0 3px 10px rgba(15,23,42,0.06); }
.form-section h2 { margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid var(--border); font-size: 18px; color: var(--text); }
.form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 15px; }
.form-group { display: flex; flex-direction: column; }
.form-group.full-width { grid-column: 1 / -1; }
.form-group label { margin-bottom: 6px; font-weight: 600; font-size: 14px; color: var(--text); }
.form-control { padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
.form-control:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(45,138,117,0.15); }
.error-messages { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
.error-messages h2 { font-size: 16px; margin: 0 0 10px 0; }
.error-messages ul { margin: 0; padding-left: 20px; }
.form-actions { display: flex; gap: 10px; margin-top: 20px; }
.equipment-fieldset { display: none; }
.equipment-fieldset.is-active { display: block; }
.existing-images { margin-bottom: 12px; }
.existing-images-label { font-size: 13px; color: #6b7280; margin-bottom: 8px; font-weight: 600; }
.image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; }
.image-item { position: relative; }
.remove-image-btn { position: absolute; top: 4px; right: 4px; background: rgba(220,38,38,0.9); color: white; border: none; padding: 4px 6px; font-size: 11px; border-radius: 4px; cursor: pointer; }
.remove-image-btn:hover { background: rgba(220,38,38,1); }
.image-upload { border: 2px dashed var(--border); padding: 20px; text-align: center; }
.image-upload:hover { border-color: var(--accent); }
.upload-help { font-size: 12px; color: #6b7280; margin-top: 6px; }
</style>

<script>
  (() => {
    const initEquipmentVisibility = () => {
      const categorySelect = document.querySelector('#product_category');
      const fieldsets = Array.from(document.querySelectorAll('[data-equipment-category]'));
      if (!categorySelect || fieldsets.length === 0) return;

      const applyState = () => {
        const selected = categorySelect.value || 'fallback';
        fieldsets.forEach((set) => {
          const match = set.dataset.equipmentCategory === selected || (set.dataset.equipmentCategory === 'fallback' && !fieldsets.some(fs => fs.dataset.equipmentCategory === selected));
          set.classList.toggle('is-active', match);
          set.querySelectorAll('input, select, textarea').forEach((input) => {
            input.disabled = !match;
          });
        });
      };

      applyState();
      categorySelect.addEventListener('change', applyState);
    };

    document.addEventListener('DOMContentLoaded', initEquipmentVisibility);
    document.addEventListener('turbo:load', initEquipmentVisibility);
  })();
</script>
